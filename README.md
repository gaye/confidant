# confidant

[![Build Status](https://travis-ci.org/gaye/confidant.png?branch=master)](https://travis-ci.org/gaye/confidant)

Configure your project for ninja's parallel and incremental builds with pure js.

### Overview

Confidant will scan the filesystem rooted at the directory from which it
is run for files named `config.js`. `config.js` files look like this:

```js
// config.js example
var denodeify = require('promise').denodeify;
var exec = require('mz/child_process').exec;
var mkdirp = denodeify(require('mkdirp'));
var move = denodeify(require('fs').rename);
var ncp = denodeify(require('ncp').ncp);
var rimraf = denodeify(require('rimraf'));
var rjs = require('requirejs');

module.exports = [
  {
    inputs: ['build.js', 'js/**/*.js'],
    output: 'app.js',
    rule: function() {
      // Run the rjs optimizer on the config in 'build.js'.
      // Depends on all of the JavaScripts in js/.
      var config = require('./build.js');
      requirejs.optimize(config);
    }
  },
  {
    inputs: ['index.html', 'app.js', 'style/**/*'],
    output: 'application.zip',
    rule: function() {
      // Make build stage directory.
      return mkdirp('stage')
      .then(function() {
        // Copy everything into the stage directory.
        return Promise.all([
          ncp('index.html', 'stage/index.html'),
          ncp('app.js', 'stage/app.js'),
          ncp('style', 'stage/style')
        ]);
      })
      .then(function() {
        // Zip everything up.
        return exec('zip application.zip index.html app.js style/', {
          cwd: './stage'
        });
      })
      .then(function() {
        // Move the zipball into the root dir.
        return move('stage/application.zip', 'application.zip');
      })
      .then(function() {
        // Delete the build stage.
        return rimraf('stage');
      });
    }
  }
];
```

And combine and convert them into a `build.ninja` file like so

```ninja
# This ninja build file was generated by confidant.
# Do not modify it directly. Instead, modify one or
# more config.js files.

rule rule-0
  command = cd /home/gareth/Documents/confidant/tmp && node -e "module.exports = [  {    inputs: ['build.js', 'js/**/*.js'],    output: 'app.js',    rule: function() {      // Run the rjs optimizer on the config in 'build.js'.      // Depends on all of the JavaScripts in js/.      var config = require('./build.js');      requirejs.optimize(config);    }  },  {    inputs: ['index.html', 'app.js', 'style/**/*'],    output: 'application.zip',    rule: function() {      // Make build stage directory.      return mkdirp('stage')      .then(function() {        // Copy everything into the stage directory.        return Promise.all([          ncp('index.html', 'stage/index.html'),          ncp('app.js', 'stage/app.js'),          ncp('style', 'stage/style')        ]);      })      .then(function() {        // Zip everything up.        return exec('zip application.zip index.html app.js style/', {          cwd: './stage'        });      })      .then(function() {        // Move the zipball into the root dir.        return move('stage/application.zip', 'application.zip');      })      .then(function() {        // Delete the build stage.        return rimraf('stage');      });    }  }];(function () {      // Run the rjs optimizer on the config in 'build.js'.      // Depends on all of the JavaScripts in js/.      var config = require('./build.js');      requirejs.optimize(config);    })()"

build /home/gareth/Documents/confidant/tmp/app.js: rule-0 build.js

rule rule-1
  command = cd /home/gareth/Documents/confidant/tmp && node -e "module.exports = [  {    inputs: ['build.js', 'js/**/*.js'],    output: 'app.js',    rule: function() {      // Run the rjs optimizer on the config in 'build.js'.      // Depends on all of the JavaScripts in js/.      var config = require('./build.js');      requirejs.optimize(config);    }  },  {    inputs: ['index.html', 'app.js', 'style/**/*'],    output: 'application.zip',    rule: function() {      // Make build stage directory.      return mkdirp('stage')      .then(function() {        // Copy everything into the stage directory.        return Promise.all([          ncp('index.html', 'stage/index.html'),          ncp('app.js', 'stage/app.js'),          ncp('style', 'stage/style')        ]);      })      .then(function() {        // Zip everything up.        return exec('zip application.zip index.html app.js style/', {          cwd: './stage'        });      })      .then(function() {        // Move the zipball into the root dir.        return move('stage/application.zip', 'application.zip');      })      .then(function() {        // Delete the build stage.        return rimraf('stage');      });    }  }];(function () {      // Make build stage directory.      return mkdirp('stage')      .then(function() {        // Copy everything into the stage directory.        return Promise.all([          ncp('index.html', 'stage/index.html'),          ncp('app.js', 'stage/app.js'),          ncp('style', 'stage/style')        ]);      })      .then(function() {        // Zip everything up.        return exec('zip application.zip index.html app.js style/', {          cwd: './stage'        });      })      .then(function() {        // Move the zipball into the root dir.        return move('stage/application.zip', 'application.zip');      })      .then(function() {        // Delete the build stage.        return rimraf('stage');      });    })()"

build /home/gareth/Documents/confidant/tmp/application.zip: rule-1 index.html app.js
```

This enables web devs to write their build rules in a comfortable
setting while leveraging ninja's ability to run independent tasks in
parallel and update targets incrementally.
